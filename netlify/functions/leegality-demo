// netlify/functions/leegality-demo.js

// ---- CORS HEADERS ----
const corsHeaders = {
  // While testing, keep "*". Once stable, change this to "https://www.leegality.com"
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Methods": "POST, OPTIONS",
  "Access-Control-Allow-Headers": "Content-Type"
};

exports.handler = async (event, context) => {
  // 1) Handle CORS preflight (OPTIONS)
  if (event.httpMethod === "OPTIONS") {
    return {
      statusCode: 200,
      headers: corsHeaders,
      body: ""
    };
  }

  // 2) Only allow POST
  if (event.httpMethod !== "POST") {
    return {
      statusCode: 405,
      headers: corsHeaders,
      body: JSON.stringify({ error: "Method not allowed" })
    };
  }

  try {
    const req = JSON.parse(event.body || "{}");
    const { name, email, contact, profileId } = req;

    if (!name || !email || !profileId) {
      return {
        statusCode: 400,
        headers: corsHeaders,
        body: JSON.stringify({
          error: "Missing required fields: name, email, profileId"
        })
      };
    }

    // Build DE demo payload â€“ this is what you were sending from Webflow earlier
    const payload = {
      name,
      username: email,
      contact: contact || "Not provided",
      profileId // e.g. "2tl8aHu" for CASA
    };

    const baseUrl =
      process.env.LEEGALITY_DEMO_BASE_URL || "https://sandbox.leegality.com";

    // Server-side call to Leegality demo API (no CORS issues here)
    const apiRes = await fetch(`${baseUrl}/api/v2.1/demo`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify(payload)
    });

    const apiData = await apiRes.json();

    if (!apiRes.ok) {
      console.error("Leegality demo API error:", apiData);
      return {
        statusCode: apiRes.status,
        headers: corsHeaders,
        body: JSON.stringify({
          error: "Leegality API error",
          details: apiData
        })
      };
    }

    const signUrl = apiData?.data?.invitations?.[0]?.signUrl;

    if (!signUrl) {
      console.error("No signUrl in response:", apiData);
      return {
        statusCode: 500,
        headers: corsHeaders,
        body: JSON.stringify({
          error: "No signUrl returned by Leegality",
          raw: apiData
        })
      };
    }

    // 3) Return signUrl to frontend
    return {
      statusCode: 200,
      headers: {
        ...corsHeaders,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ signUrl })
    };
  } catch (err) {
    console.error("Netlify function error:", err);
    return {
      statusCode: 500,
      headers: corsHeaders,
      body: JSON.stringify({ error: "Internal server error" })
    };
  }
};
