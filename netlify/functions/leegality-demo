// netlify/functions/de-demo-invite.js
const axios = require("axios");

// --- CORS headers (start with *; later restrict to https://leegality.com) ---
const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "Content-Type",
  "Access-Control-Allow-Methods": "POST, OPTIONS"
};

exports.handler = async (event, context) => {
  // 1) Handle preflight
  if (event.httpMethod === "OPTIONS") {
    return {
      statusCode: 200,
      headers: corsHeaders,
      body: ""
    };
  }

  // 2) Only POST allowed
  if (event.httpMethod !== "POST") {
    return {
      statusCode: 405,
      headers: corsHeaders,
      body: JSON.stringify({ error: "Method not allowed" })
    };
  }

  try {
    const { name, email, contact, profileId } = JSON.parse(event.body || "{}");

    if (!name || !email || !profileId) {
      return {
        statusCode: 400,
        headers: corsHeaders,
        body: JSON.stringify({
          success: false,
          error: "Missing required fields: name, email, profileId"
        })
      };
    }

    // Payload for DE demo endpoint
    const leegalityPayload = {
      name,
      username: email,
      contact: contact || "Not provided",
      profileId // e.g. "2tl8aHu" for CASA
    };

    const baseUrl =
      process.env.LEEGALITY_BASE_URL || "https://sandbox.leegality.com";

    // 3) Call Leegality demo API from backend (NO CORS here, this is server-to-server)
    const response = await axios.post(
      `${baseUrl}/api/v2.1/demo`,
      leegalityPayload,
      {
        headers: {
          "Content-Type": "application/json"
          // For real v3 esign: also add 'X-Auth-Token': process.env.LEEGALITY_AUTH_TOKEN
        }
      }
    );

    const apiData = response.data;
    const signUrl = apiData?.data?.invitations?.[0]?.signUrl;

    if (!signUrl) {
      return {
        statusCode: 500,
        headers: corsHeaders,
        body: JSON.stringify({
          success: false,
          error: "No signUrl returned by Leegality",
          raw: apiData
        })
      };
    }

    // 4) Return signUrl to frontend
    return {
      statusCode: 200,
      headers: {
        ...corsHeaders,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        success: true,
        signUrl
      })
    };
  } catch (error) {
    console.error("DE demo function error:", error.response?.data || error);

    return {
      statusCode: error.response?.status || 500,
      headers: {
        ...corsHeaders,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        success: false,
        error: error.response?.data || error.message
      })
    };
  }
};
