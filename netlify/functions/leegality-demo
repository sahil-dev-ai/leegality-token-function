// netlify/functions/leegality-demo.js

// ✅ CORS headers
const corsHeaders = {
  // You can start with "*" while testing.
  // For production, you can restrict this to "https://leegality.com"
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Methods": "POST, OPTIONS",
  "Access-Control-Allow-Headers": "Content-Type"
};

exports.handler = async (event, context) => {
  // ✅ Handle preflight just in case browser still sends OPTIONS
  if (event.httpMethod === "OPTIONS") {
    return {
      statusCode: 204,
      headers: corsHeaders,
      body: ""
    };
  }

  if (event.httpMethod !== "POST") {
    return {
      statusCode: 405,
      headers: corsHeaders,
      body: JSON.stringify({ error: "Method Not Allowed" })
    };
  }

  try {
    // ✅ We will send JSON as text/plain from frontend to AVOID preflight.
    // So event.body is still JSON string.
    const body = event.body ? JSON.parse(event.body) : {};
    const { name, username, contact, profileId } = body;

    if (!name || !username || !profileId) {
      return {
        statusCode: 400,
        headers: corsHeaders,
        body: JSON.stringify({
          error: "Missing required fields: name, username, profileId"
        })
      };
    }

    const payload = {
      name,
      username,
      contact: contact || "Not provided",
      profileId
    };

    const baseUrl =
      process.env.LEEGALITY_BASE_URL || "https://sandbox.leegality.com";

    const apiRes = await fetch(`${baseUrl}/api/v2.1/demo`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify(payload)
    });

    const data = await apiRes.json();

    if (!apiRes.ok) {
      console.error("Leegality demo API error:", data);
      return {
        statusCode: apiRes.status,
        headers: corsHeaders,
        body: JSON.stringify({
          error: "Leegality API error",
          details: data
        })
      };
    }

    const signUrl = data?.data?.invitations?.[0]?.signUrl;

    if (!signUrl) {
      console.error("No signUrl in response:", data);
      return {
        statusCode: 500,
        headers: corsHeaders,
        body: JSON.stringify({
          error: "No signUrl returned by Leegality",
          raw: data
        })
      };
    }

    return {
      statusCode: 200,
      headers: corsHeaders,
      body: JSON.stringify({ signUrl })
    };
  } catch (err) {
    console.error("Netlify function error:", err);
    return {
      statusCode: 500,
      headers: corsHeaders,
      body: JSON.stringify({ error: "Internal server error" })
    };
  }
};
